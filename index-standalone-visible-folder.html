
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wealthsimple budgeting app</title>
  <style>

:root{
  --bg:#0b1020;
  --panel:#121a32;
  --text:#e6eefc;
  --muted:#98a2b3;
  --primary:#7c3aed;
  --primary-2:#4f46e5;
  --accent:#06b6d4;
  --success:#10b981;
  --danger:#ef4444;
  --border:#223055;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter,Segoe UI,Roboto,system-ui,-apple-system,sans-serif;
  background:linear-gradient(180deg,#0b1020 0%,#0d1428 100%);
  color:var(--text);
}
.app-header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--border);backdrop-filter: blur(6px);position:sticky;top:0;background:rgba(10,14,28,0.6)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;font-weight:800}
.titles h1{margin:0;font-size:20px}
.subtitle{margin:2px 0 0;color:var(--muted);font-size:12px}
.actions{display:flex;gap:8px}
button{background:var(--primary-2);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:0 4px 16px rgba(79,70,229,.3);transition:.2s}
button.ghost{background:transparent;border:1px solid var(--border);box-shadow:none}
button.danger{border-color:var(--danger);color:#ffd2d2}
button:disabled{opacity:.6;cursor:not-allowed}
.tabs{display:flex;gap:8px;padding:12px 24px;border-bottom:1px solid var(--border)}
.tab{background:transparent;border:1px solid var(--border);color:var(--text)}
.tab.active{background:var(--primary-2)}
main{padding:24px;max-width:1200px;margin:0 auto}
.card{background:rgba(18,26,50,.7);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:24px}
.card-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}
.card-header .row{display:flex;gap:8px;align-items:center}
.card-footer{padding:8px 16px;border-top:1px solid var(--border);color:var(--muted)}
.table-wrapper{overflow:auto;max-height:60vh}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid var(--border)}
th{position:sticky;top:0;background:rgba(15,20,40,.9);backdrop-filter:blur(4px);text-align:left;color:#c7d2fe;cursor:pointer}
.num{text-align:right}
input,select{background:rgba(10,16,32,.6);border:1px solid var(--border);padding:10px;border-radius:10px;color:var(--text)}
input[type=color]{padding:0;height:38px;width:60px}
.row{display:flex;gap:8px;align-items:center}
.row.wrap{flex-wrap:wrap}
.grid{display:grid;grid-template-columns:1fr;gap:24px}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
.log{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(0,0,0,.2);padding:12px;border-radius:12px;border:1px dashed var(--border);min-height:48px}
.badge{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
.cat-dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-right:6px}
.tag{border:1px solid var(--border);padding:6px 8px;border-radius:9999px;font-size:12px}
/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:grid;place-items:center}
.modal.hidden{display:none}
.modal-card{width:min(720px, 96vw);background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
.modal-body{padding:12px}
.modal-footer{padding:10px 12px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.link{color:#93c5fd;text-decoration:none}
.summary{display:flex;gap:16px;flex-wrap:wrap}
.small{font-size:12px;color:var(--muted)}
.toast{position:fixed;right:16px;bottom:16px;background:#162041;border:1px solid var(--border);padding:10px 12px;border-radius:10px}

.file-button{
  border:1px dashed var(--border); padding:10px; border-radius:10px; color:var(--text); background:transparent;
}
.file-button-label{
  display:inline-block; border:1px solid var(--border); padding:10px 14px; border-radius:10px; cursor:pointer;
}
.file-button::-webkit-file-upload-button{
  color:white; background:var(--primary-2); border:none; padding:8px 12px; border-radius:8px; margin-right:8px; cursor:pointer;
}

</style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <div class="logo">WS</div>
      <div class="titles">
        <h1>Wealthsimple budgeting app</h1>
        <p class="subtitle">Private, fast, and local â€” no server required</p>
      </div>
    </div>
    <div class="actions">
      <button id="btn-darkmode" class="ghost">ðŸŒ™ Dark</button>
      <button id="btn-reset" class="danger ghost" title="Clear localStorage and reload">Reset</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="transactions">Transactions</button>
    <button class="tab" data-tab="categories">Categories</button>
    <button class="tab" data-tab="rules">Rules</button>
    <button class="tab" data-tab="analytics">Analytics</button>
    <button class="tab" data-tab="import">Import / Export</button>
  </nav>

  <main>
    <!-- Transactions -->
    <section id="tab-transactions" class="tab-pane active">
      <div class="card">
        <div class="card-header">
          <div class="row">
            <input type="search" id="tx-search" placeholder="Search description, payee, account..." />
            <select id="tx-filter-category">
              <option value="">All categories</option>
            </select>
            <input type="month" id="tx-filter-month" />
            <button id="btn-clear-tx-filters" class="ghost">Clear</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table id="tx-table">
            <thead>
              <tr>
                <th data-sort="date">Date</th>
                <th data-sort="description">Description</th>
                <th data-sort="payee">Payee</th>
                <th data-sort="account">Account</th>
                <th data-sort="amount" class="num">Amount</th>
                <th>Category</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card-footer">
          <div class="summary" id="tx-summary"></div>
        </div>
      </div>
    </section>

    <!-- Categories -->
    <section id="tab-categories" class="tab-pane">
      <div class="card">
        <div class="card-header">
          <h3>Categories</h3>
          <div class="row">
            <input id="cat-name" placeholder="New category name" />
            <input id="cat-color" type="color" value="#4f46e5" />
            <button id="btn-add-category">Add</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table id="cat-table">
            <thead>
              <tr><th>Name</th><th>Color</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Rules -->
    <section id="tab-rules" class="tab-pane">
      <div class="card">
        <div class="card-header">
          <h3>Rules</h3>
          <div class="row wrap">
            <button id="btn-add-rule">New Rule</button>
            <button id="btn-apply-rules" class="primary">Apply Rules</button>
            <input type="file" id="rules-upload" accept="application/json" hidden />
            <button id="btn-upload-rules" class="ghost">Upload Rules</button>
            <button id="btn-download-rules" class="ghost">Download Rules</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table id="rules-table">
            <thead>
              <tr>
                <th>Priority</th>
                <th>Name</th>
                <th>Condition</th>
                <th>Action</th>
                <th>Enabled</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Analytics -->
    <section id="tab-analytics" class="tab-pane">
      <div class="grid">
        <div class="card">
          <div class="card-header"><h3>Monthly Net Spending</h3></div>
          <canvas id="chart-monthly" width="800" height="320"></canvas>
        </div>
        <div class="card">
          <div class="card-header"><h3>Spend by Category</h3></div>
          <canvas id="chart-category" width="800" height="320"></canvas>
        </div>
      </div>
    </section>

    <!-- Import / Export -->
    <section id="tab-import" class="tab-pane">
      <div class="card">
        <div class="card-header">
          <h3>Import Statements</h3>
          <p>Pick a folder of CSVs or choose files. Data never leaves your browser.</p>
        </div>
        <div class="content">
          <div class="row wrap">
            <input id="folder-input" class="file-button" type="file" webkitdirectory directory multiple />
            <button id="btn-upload-folder" class="ghost">Upload Folder (JS)</button>
<label for="folder-input" class="file-button-label">Upload Folder (Direct)</label>
            <input id="files-input" type="file" accept=".csv,text/csv" multiple hidden />
            <button id="btn-upload-files">Upload Files</button>
            <button id="btn-fsa" class="ghost" title="Use File System Access API if available">Open Folder (FSA)</button>
          </div>
          <div id="import-log" class="log"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h3>Data Export</h3></div>
        <div class="row wrap">
          <button id="btn-export-transactions" class="ghost">Download Transactions (CSV)</button>
          <button id="btn-export-categories" class="ghost">Download Categories (JSON)</button>
          <button id="btn-export-backup" class="ghost">Full Backup (JSON)</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="modal-title">Modal</h3>
        <button id="modal-close" class="icon">âœ•</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer" id="modal-footer"></div>
    </div>
  </div>

  <script>const APP_VERSION = '1.1.0';</script>
  <script>

// ===== Utilities =====
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = new Intl.NumberFormat(undefined,{style:'currency',currency:'CAD'});
const fmtDate = d => new Date(d).toISOString().slice(0,10);

// Storage
const STORAGE_KEYS = {
  version: 'wsb_version',
  transactions: 'wsb_transactions',
  categories: 'wsb_categories',
  rules: 'wsb_rules',
};

const defaultCategories = [
  {id:'uncategorized', name:'Uncategorized', color:'#6b7280'},
  {id:cryptoId(), name:'Groceries', color:'#22c55e'},
  {id:cryptoId(), name:'Dining', color:'#f59e0b'},
  {id:cryptoId(), name:'Transport', color:'#3b82f6'},
  {id:cryptoId(), name:'Bills', color:'#ef4444'},
  {id:cryptoId(), name:'Income', color:'#10b981'}
];

function cryptoId(){
  // short id
  return Math.random().toString(36).slice(2,10);
}

function loadJSON(key, fallback){
  try{ const j = localStorage.getItem(key); return j? JSON.parse(j): structuredClone(fallback);}catch(e){return structuredClone(fallback)}
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function toast(msg){
  const t = document.createElement('div'); t.className='toast'; t.textContent = msg; document.body.appendChild(t);
  setTimeout(()=>{ t.remove(); }, 2200);
}

// ===== App State =====
let state = {
  transactions: [], // {id,date,description,payee,account,amount,categoryId,manual}
  categories: [],
  rules: [],
};

// ===== Init & Migration =====
(function init(){
  const storedVersion = localStorage.getItem(STORAGE_KEYS.version);
  if(!storedVersion){
    // Seed with sample data if first run
    state.categories = defaultCategories;
    state.transactions = sampleTransactions();
    state.rules = sampleRules();
    persistAll();
    localStorage.setItem(STORAGE_KEYS.version, APP_VERSION);
  } else {
    state.categories = loadJSON(STORAGE_KEYS.categories, defaultCategories);
    state.transactions = loadJSON(STORAGE_KEYS.transactions, []);
    state.rules = loadJSON(STORAGE_KEYS.rules, []);
    migrate(storedVersion, APP_VERSION);
  }
  mountUI();
})();

function migrate(fromV, toV){
  if(fromV !== toV){
    // Example migration hooks for future versions.
    // Ensure every transaction has id and categoryId fields.
    let changed=false;
    state.transactions.forEach(tx=>{
      if(!tx.id){ tx.id = cryptoId(); changed=true; }
      if(!('categoryId' in tx)){ tx.categoryId = 'uncategorized'; changed=true; }
    });
    // Ensure categories have id
    state.categories.forEach(c=>{ if(!c.id) { c.id=cryptoId(); } });
    if(changed) saveJSON(STORAGE_KEYS.transactions, state.transactions);
    localStorage.setItem(STORAGE_KEYS.version, toV);
  }
}

function persistAll(){
  saveJSON(STORAGE_KEYS.transactions, state.transactions);
  saveJSON(STORAGE_KEYS.categories, state.categories);
  saveJSON(STORAGE_KEYS.rules, state.rules);
}

// ===== Sample Data =====
function sampleTransactions(){
  // small seed; real samples also in /sample-data
  const arr = [
    {date:'2025-08-28', description:'Loblaws Bank St', payee:'Loblaws', account:'VISA **** 4242', amount:-82.14},
    {date:'2025-08-29', description:'OC Transpo', payee:'OC Transpo', account:'VISA **** 4242', amount:-3.75},
    {date:'2025-08-30', description:'Restaurant Norca', payee:'Norca', account:'MC **** 1881', amount:-56.20},
    {date:'2025-09-01', description:'Paycheque', payee:'Employer', account:'Chequing', amount:3250.00},
    {date:'2025-09-02', description:'Hydro Ottawa', payee:'Hydro Ottawa', account:'VISA **** 4242', amount:-120.10},
    {date:'2025-09-05', description:'Amazon Marketplace', payee:'Amazon', account:'VISA **** 4242', amount:-45.89},
  ].map(x=>({...x, id:cryptoId(), categoryId: x.amount>0? state.categories?.find(c=>c.name==='Income')?.id || 'uncategorized':'uncategorized'}));
  return arr;
}

function sampleRules(){
  return [
    { id: cryptoId(), name:'Groceries: Loblaws/Metro', enabled:true, priority:1,
      conditions:[{field:'description', op:'contains', value:'loblaw'},{field:'description', op:'contains', value:'metro', any:true}],
      action:{ type:'setCategoryByName', value:'Groceries' }
    },
    { id: cryptoId(), name:'Transit', enabled:true, priority:2,
      conditions:[{field:'description', op:'contains', value:'transpo'}],
      action:{ type:'setCategoryByName', value:'Transport' }
    },
    { id: cryptoId(), name:'Income: Paycheque', enabled:true, priority:3,
      conditions:[{field:'description', op:'contains', value:'paycheque'}],
      action:{ type:'setCategoryByName', value:'Income' }
    },
    { id: cryptoId(), name:'Utilities', enabled:true, priority:4,
      conditions:[{field:'description', op:'contains', value:'hydro'}],
      action:{ type:'setCategoryByName', value:'Bills' }
    },
  ];
}

// ===== UI Mount =====
function mountUI(){
  // Tabs
  $$('.tab').forEach(btn=>btn.addEventListener('click',()=>{
    $$('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    $$('.tab-pane').forEach(p=>p.classList.remove('active'));
    $('#tab-'+tab).classList.add('active');
    if(tab==='analytics') renderCharts();
  }));

  // Dark mode toggle
  $('#btn-darkmode').addEventListener('click',()=>{
    document.body.classList.toggle('light');
  });

  $('#btn-reset').addEventListener('click',()=>{
    if(confirm('This will clear local data (transactions, categories, rules). Continue?')){
      localStorage.clear(); location.reload();
    }
  });

  // Transactions
  renderCategoryFilter();
  renderTransactions();
  $('#tx-search').addEventListener('input', renderTransactions);
  $('#tx-filter-category').addEventListener('change', renderTransactions);
  $('#tx-filter-month').addEventListener('change', renderTransactions);
  $('#btn-clear-tx-filters').addEventListener('click',()=>{
    $('#tx-search').value=''; $('#tx-filter-category').value=''; $('#tx-filter-month').value=''; renderTransactions();
  });

  // Categories
  renderCategories();
  $('#btn-add-category').addEventListener('click', addCategory);

  // Rules
  renderRules();
  $('#btn-add-rule').addEventListener('click', ()=> openRuleModal());
  $('#btn-apply-rules').addEventListener('click', ()=>{ applyRulesToAll(); renderTransactions(); renderCharts(true); toast('Rules applied'); });
  $('#btn-upload-rules').addEventListener('click', ()=> $('#rules-upload').click());
  $('#rules-upload').addEventListener('change', handleRulesUpload);
  $('#btn-download-rules').addEventListener('click', downloadRules);

  // Import/Export
  $('#btn-upload-folder').addEventListener('click', ()=> $('#folder-input').click());
  $('#folder-input').addEventListener('change', (e)=> handleFiles(e.target.files));
  $('#btn-upload-files').addEventListener('click', ()=> $('#files-input').click());
  $('#files-input').addEventListener('change', (e)=> handleFiles(e.target.files));
  $('#btn-fsa').addEventListener('click', openFolderFSA);

  $('#btn-export-transactions').addEventListener('click', exportTransactionsCSV);
  $('#btn-export-categories').addEventListener('click', exportCategoriesJSON);
  $('#btn-export-backup').addEventListener('click', exportBackupJSON);
}

// ===== Transactions Table =====
let txSort = {by:'date', dir:'desc'};
$$('#tx-table thead th').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.dataset.sort; if(!key) return;
    if(txSort.by===key) txSort.dir = txSort.dir==='asc'?'desc':'asc'; else { txSort.by=key; txSort.dir='asc'; }
    renderTransactions();
  });
});

function renderCategoryFilter(){
  const sel = $('#tx-filter-category');
  sel.innerHTML = '<option value="">All categories</option>' + state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}

function renderTransactions(){
  const q = $('#tx-search').value.toLowerCase();
  const cat = $('#tx-filter-category').value;
  const month = $('#tx-filter-month').value; // yyyy-mm
  let rows = state.transactions.slice();
  // Filter
  rows = rows.filter(tx=>{
    const inQ = !q || [tx.description, tx.payee, tx.account].some(s=> (s||'').toLowerCase().includes(q));
    const inCat = !cat || tx.categoryId===cat;
    const inMonth = !month || (tx.date||'').slice(0,7)===month;
    return inQ && inCat && inMonth;
  });
  // Sort
  rows.sort((a,b)=>{
    const va = a[txSort.by];
    const vb = b[txSort.by];
    if(txSort.by==='amount') return txSort.dir==='asc'? va-vb : vb-va;
    return txSort.dir==='asc'? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });

  const tbody = $('#tx-table tbody');
  tbody.innerHTML = rows.map(tx=>{
    const cat = state.categories.find(c=>c.id===tx.categoryId) || state.categories.find(c=>c.id==='uncategorized');
    return `<tr>
      <td>${fmtDate(tx.date)}</td>
      <td>${escapeHtml(tx.description||'')}</td>
      <td>${escapeHtml(tx.payee||'')}</td>
      <td>${escapeHtml(tx.account||'')}</td>
      <td class="num">${fmt.format(Number(tx.amount||0))}</td>
      <td>
        <span class="cat-dot" style="background:${cat?.color||'#6b7280'}"></span>
        <select data-txid="${tx.id}" class="tx-cat">${state.categories.map(c=>`<option value="${c.id}" ${c.id===tx.categoryId?'selected':''}>${c.name}</option>`).join('')}</select>
      </td>
    </tr>`;
  }).join('');

  // attach change listeners for category
  $$('#tx-table select.tx-cat').forEach(sel=> sel.addEventListener('change', (e)=>{
    const id = e.target.getAttribute('data-txid');
    const tx = state.transactions.find(t=>t.id===id);
    if(tx){ tx.categoryId = e.target.value; tx.manual = true; saveJSON(STORAGE_KEYS.transactions, state.transactions); renderCharts(true); }
  }));

  // summary
  const total = rows.reduce((s,t)=> s + Number(t.amount||0), 0);
  const spend = rows.filter(t=>t.amount<0).reduce((s,t)=> s + Number(t.amount), 0);
  const income = rows.filter(t=>t.amount>0).reduce((s,t)=> s + Number(t.amount), 0);
  $('#tx-summary').innerHTML = `<span class="tag">Transactions: ${rows.length}</span>
    <span class="tag">Income: <b>${fmt.format(income)}</b></span>
    <span class="tag">Spend: <b>${fmt.format(spend)}</b></span>
    <span class="tag">Net: <b>${fmt.format(total)}</b></span>`;
}

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

// ===== Categories =====
function renderCategories(){
  const tbody = $('#cat-table tbody');
  tbody.innerHTML = state.categories.map(c=>`<tr>
    <td><input value="${escapeHtml(c.name)}" data-cid="${c.id}" class="cat-name-input" /></td>
    <td><input type="color" value="${c.color}" data-cid="${c.id}" class="cat-color-input" /></td>
    <td>
      ${c.id==='uncategorized'? '<span class="small">Protected</span>' : `<button data-cid="${c.id}" class="ghost btn-del-cat">Delete</button>`}
    </td>
  </tr>`).join('');

  $$('.cat-name-input').forEach(inp=> inp.addEventListener('change', (e)=>{
    const c = state.categories.find(x=>x.id===e.target.dataset.cid); if(!c) return; c.name = e.target.value.trim()||c.name; saveJSON(STORAGE_KEYS.categories, state.categories); renderCategoryFilter(); renderTransactions(); renderRules(); renderCharts(true);
  }));
  $$('.cat-color-input').forEach(inp=> inp.addEventListener('change', (e)=>{
    const c = state.categories.find(x=>x.id===e.target.dataset.cid); if(!c) return; c.color = e.target.value; saveJSON(STORAGE_KEYS.categories, state.categories); renderTransactions(); renderCharts(true);
  }));
  $$('.btn-del-cat').forEach(btn=> btn.addEventListener('click',()=>{
    const id = btn.dataset.cid; const cat = state.categories.find(c=>c.id===id);
    if(!cat) return; if(!confirm(`Delete category "${cat.name}"? Transactions will move to Uncategorized.`)) return;
    state.categories = state.categories.filter(c=>c.id!==id);
    state.transactions.forEach(t=>{ if(t.categoryId===id) t.categoryId='uncategorized'; });
    saveJSON(STORAGE_KEYS.categories, state.categories); saveJSON(STORAGE_KEYS.transactions, state.transactions);
    renderCategoryFilter(); renderCategories(); renderTransactions(); renderRules(); renderCharts(true);
  }));
}

function addCategory(){
  const name = $('#cat-name').value.trim(); const color = $('#cat-color').value;
  if(!name) return toast('Enter a category name');
  const c = {id: cryptoId(), name, color};
  state.categories.push(c);
  saveJSON(STORAGE_KEYS.categories, state.categories);
  $('#cat-name').value='';
  renderCategoryFilter(); renderCategories(); renderTransactions(); renderRules(); renderCharts(true);
}

// ===== Rules =====
function renderRules(){
  const sorted = state.rules.slice().sort((a,b)=> (a.priority||999)-(b.priority||999));
  const tbody = $('#rules-table tbody');
  tbody.innerHTML = sorted.map((r,i)=> `<tr>
    <td>${r.priority||i+1}</td>
    <td>${escapeHtml(r.name)}</td>
    <td>${renderRuleCondText(r)}</td>
    <td><span class="badge">${escapeHtml(r.action?.type||'')}</span> â†’ ${escapeHtml(ruleActionToText(r.action))}</td>
    <td><input type="checkbox" data-id="${r.id}" class="rule-enabled" ${r.enabled? 'checked':''}></td>
    <td>
      <button class="ghost btn-edit-rule" data-id="${r.id}">Edit</button>
      <button class="ghost btn-del-rule" data-id="${r.id}">Delete</button>
    </td>
  </tr>`).join('');

  $$('.rule-enabled').forEach(chk=> chk.addEventListener('change', (e)=>{
    const r = state.rules.find(x=>x.id===e.target.dataset.id); if(!r) return; r.enabled = e.target.checked; saveJSON(STORAGE_KEYS.rules, state.rules);
  }));
  $$('.btn-edit-rule').forEach(btn=> btn.addEventListener('click', ()=>{
    const r = state.rules.find(x=>x.id===btn.dataset.id); if(r) openRuleModal(r);
  }));
  $$('.btn-del-rule').forEach(btn=> btn.addEventListener('click', ()=>{
    const r = state.rules.find(x=>x.id===btn.dataset.id); if(!r) return; if(!confirm('Delete rule?')) return; state.rules = state.rules.filter(x=>x.id!==r.id); saveJSON(STORAGE_KEYS.rules, state.rules); renderRules();
  }));
}

function renderRuleCondText(r){
  if(!r.conditions?.length) return '<span class=small>No condition</span>';
  return r.conditions.map(c=>{
    const f = c.field; const op = c.op; const v = c.value; const any = c.any? ' (any)': '';
    return `<span class="tag">${f} ${op} "${escapeHtml(String(v))}"${any}</span>`;
  }).join(' ');
}
function ruleActionToText(a){
  if(!a) return '';
  if(a.type==='setCategoryByName') return `Category: ${a.value}`;
  if(a.type==='setCategoryById') return `Category ID: ${a.value}`;
  return JSON.stringify(a);
}

function openRuleModal(rule){
  const isEdit = !!rule;
  const m = $('#modal'); m.classList.remove('hidden');
  $('#modal-title').textContent = isEdit? 'Edit Rule' : 'New Rule';
  const cOptions = state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  $('#modal-body').innerHTML = `
    <div class="row" style="margin-bottom:8px">
      <label style="width:120px">Name</label>
      <input id="rule-name" value="${escapeHtml(rule?.name||'')}" style="flex:1" />
    </div>
    <div class="small" style="margin-bottom:6px">Conditions (match ALL unless a condition has <code>any</code>=true, then ANY)</div>
    <div id="conds"></div>
    <button id="btn-add-cond" class="ghost" style="margin:6px 0">+ Add Condition</button>
    <div class="row" style="margin-top:8px">
      <label style="width:120px">Action</label>
      <select id="rule-action-type">
        <option value="setCategoryById">Set Category (by ID)</option>
        <option value="setCategoryByName" selected>Set Category (by Name)</option>
      </select>
      <select id="rule-action-value">${cOptions}</select>
    </div>
    <div class="row" style="margin-top:8px">
      <label style="width:120px">Priority</label>
      <input id="rule-priority" type="number" min="1" value="${rule?.priority||''}" />
      <label style="width:120px">Enabled</label>
      <input id="rule-enabled" type="checkbox" ${rule?.enabled!==false? 'checked':''} />
    </div>
  `;
  const condsEl = $('#conds');
  function addCondRow(c={field:'description', op:'contains', value:''}){
    const row = document.createElement('div'); row.className='row'; row.style.margin='4px 0';
    row.innerHTML = `
      <select class="cond-field">
        <option value="description">description</option>
        <option value="payee">payee</option>
        <option value="account">account</option>
        <option value="amount">amount</option>
      </select>
      <select class="cond-op">
        <option value="contains">contains</option>
        <option value="equals">equals</option>
        <option value="regex">regex</option>
        <option value="lt">&lt;</option>
        <option value="gt">&gt;</option>
      </select>
      <input class="cond-value" placeholder="value" />
      <label class="small"><input type="checkbox" class="cond-any"/> any</label>
      <button class="ghost btn-del-cond">âœ•</button>
    `;
    row.querySelector('.cond-field').value=c.field||'description';
    row.querySelector('.cond-op').value=c.op||'contains';
    row.querySelector('.cond-value').value=c.value??'';
    row.querySelector('.cond-any').checked=!!c.any;
    row.querySelector('.btn-del-cond').addEventListener('click',()=>{ row.remove(); });
    condsEl.appendChild(row);
  }
  (rule?.conditions||[{}]).forEach(addCondRow);
  $('#btn-add-cond').addEventListener('click',()=> addCondRow({}));

  $('#modal-footer').innerHTML = `
    <button id="modal-cancel" class="ghost">Cancel</button>
    <button id="modal-save" class="primary">Save</button>
  `;
  $('#modal-cancel').onclick = closeModal;
  $('#modal-save').onclick = ()=>{
    const name = $('#rule-name').value.trim()||'Untitled rule';
    const actionType = $('#rule-action-type').value;
    const actionValSel = $('#rule-action-value');
    const action = actionType==='setCategoryById' ? {type:actionType, value: actionValSel.value} : {type:actionType, value: (state.categories.find(c=>c.id===actionValSel.value)||{}).name };
    const priority = Number($('#rule-priority').value)||undefined;
    const enabled = $('#rule-enabled').checked;
    const conds = Array.from(condsEl.children).map(row=>({
      field: row.querySelector('.cond-field').value,
      op: row.querySelector('.cond-op').value,
      value: row.querySelector('.cond-value').value,
      any: row.querySelector('.cond-any').checked,
    }));
    if(isEdit){ Object.assign(rule, {name, action, priority, enabled, conditions:conds}); }
    else { state.rules.push({id:cryptoId(), name, action, priority, enabled, conditions:conds}); }
    saveJSON(STORAGE_KEYS.rules, state.rules); renderRules(); closeModal();
  };
}

function closeModal(){ $('#modal').classList.add('hidden'); }
$('#modal-close').addEventListener('click', closeModal);

// ===== Rule Engine =====
function applyRulesToAll(){
  const rules = state.rules.filter(r=>r.enabled!==false).sort((a,b)=> (a.priority||999)-(b.priority||999));
  let changed=false;
  for(const tx of state.transactions){
    const before = tx.categoryId;
    const match = rules.find(r=> ruleMatches(r, tx));
    if(match){
      const newCat = resolveRuleCategory(match);
      if(newCat){ tx.categoryId = newCat.id; if(before!==tx.categoryId) changed=true; }
    }
  }
  if(changed) saveJSON(STORAGE_KEYS.transactions, state.transactions);
}

function ruleMatches(rule, tx){
  if(!rule.conditions?.length) return false;
  // AND across conditions unless condition.any is true â€” then use OR semantics among 'any' subset
  const allConds = rule.conditions;
  const anyConds = allConds.filter(c=>c.any);
  const mustConds = allConds.filter(c=>!c.any);
  const mustOk = mustConds.every(c=> condOk(c, tx));
  const anyOk = anyConds.length? anyConds.some(c=> condOk(c, tx)) : true;
  return mustOk && anyOk;
}

function condOk(c, tx){
  const val = (tx[c.field]??'').toString().toLowerCase();
  const cmp = (c.value??'').toString().toLowerCase();
  switch(c.op){
    case 'contains': return val.includes(cmp);
    case 'equals': return val===cmp;
    case 'regex':
      try{ const re = new RegExp(c.value, 'i'); return re.test(tx[c.field]??''); }catch(e){ return false; }
    case 'lt': return Number(tx[c.field]) < Number(c.value);
    case 'gt': return Number(tx[c.field]) > Number(c.value);
    default: return false;
  }
}

function resolveRuleCategory(rule){
  if(rule.action?.type==='setCategoryById'){
    return state.categories.find(c=>c.id===rule.action.value);
  }
  if(rule.action?.type==='setCategoryByName'){
    const byName = state.categories.find(c=> c.name.toLowerCase()===String(rule.action.value||'').toLowerCase());
    return byName || state.categories.find(c=>c.id==='uncategorized');
  }
  return null;
}

function handleRulesUpload(e){
  const file = e.target.files?.[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const imported = JSON.parse(reader.result);
      if(!Array.isArray(imported)) throw new Error('Invalid rules file');
      state.rules = imported; saveJSON(STORAGE_KEYS.rules, state.rules);
      applyRulesToAll(); saveJSON(STORAGE_KEYS.transactions, state.transactions);
      renderRules(); renderTransactions(); renderCharts(true);
      toast('Rules uploaded & applied');
    }catch(err){ alert('Failed to import rules: '+ err.message); }
  };
  reader.readAsText(file);
}

function downloadRules(){
  const blob = new Blob([JSON.stringify(state.rules,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rules.json'; a.click(); URL.revokeObjectURL(a.href);
}

// ===== Importers =====
async function handleFiles(fileList){
  const files = Array.from(fileList).filter(f=> f.name.toLowerCase().endsWith('.csv'));
  if(!files.length){ toast('No CSV files found'); return; }
  const log = $('#import-log');
  let imported=0, skipped=0;
  for(const f of files){
    const text = await f.text();
    const rows = parseCSV(text);
    const mapped = mapStatementRows(rows);
    if(mapped.length){ state.transactions.push(...mapped); imported += mapped.length; log.innerHTML += `Imported ${mapped.length} from <b>${escapeHtml(f.name)}</b><br/>`; }
    else { skipped++; log.innerHTML += `Skipped <b>${escapeHtml(f.name)}</b> (no rows)<br/>`; }
  }
  applyRulesToAll();
  saveJSON(STORAGE_KEYS.transactions, state.transactions);
  renderTransactions(); renderCharts(true);
  toast(`Imported ${imported} rows${skipped? ', skipped '+skipped: ''}`);
}

function parseCSV(text){
  // simple CSV (handles quotes and commas)
  const lines = text.replace(/
?/g, '
').split('
').filter(x=>x.trim().length);
  if(!lines.length) return [];
  const headers = splitCSVLine(lines[0]).map(h=>h.trim());
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    if(cols.length===1 && !cols[0]) continue;
    const obj = {}; headers.forEach((h,idx)=> obj[h] = cols[idx]);
    rows.push(obj);
  }
  return rows;
}

function splitCSVLine(line){
  const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){
      if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
      else inQ=!inQ;
    } else if(ch===',' && !inQ){ out.push(cur); cur=''; }
    else cur+=ch;
  } out.push(cur); return out;
}

function mapStatementRows(rows){
  // Try to detect columns across banks; normalize to {id,date,description,payee,account,amount,categoryId}
  const normName = s=> String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
  if(!rows.length) return [];
  const headers = Object.keys(rows[0]);
  const map = {};
  for(const h of headers){
    const n = normName(h);
    if(['date','transactiondate','posteddate','purchaseon'].includes(n)) map.date = h;
    if(['description','details','narrative','merchant','memo'].includes(n)) map.description = h;
    if(['payee','name','merchant','vendor'].includes(n)) map.payee = h;
    if(['account','card','cardnumber','accountname','accountnumber'].includes(n)) map.account = h;
    if(['amount','cadamount','total','value'].includes(n)) map.amount = h;
    if(['debit','withdrawal'].includes(n)) map.debit = h;
    if(['credit','deposit'].includes(n)) map.credit = h;
  }
  const out=[];
  for(const r of rows){
    let amount = 0;
    if(map.amount){ amount = Number(String(r[map.amount]).replace(/[^0-9.-]/g,'')) || 0; }
    else if(map.debit || map.credit){
      const debit = Number(String(r[map.debit]??'').replace(/[^0-9.-]/g,''))||0;
      const credit = Number(String(r[map.credit]??'').replace(/[^0-9.-]/g,''))||0;
      amount = credit - debit; // positive if credit/income
    } else { continue; }
    const dateRaw = r[map.date] || r[map.posteddate] || r[map.transactiondate] || r[map.purchaseon];
    const date = normalizeDate(dateRaw);
    out.push({
      id: cryptoId(),
      date,
      description: r[map.description]||r[map.payee]||'',
      payee: r[map.payee]||'',
      account: r[map.account]||'Imported',
      amount,
      categoryId: 'uncategorized',
    });
  }
  return out;
}

function normalizeDate(x){
  if(!x) return fmtDate(new Date());
  // Try common formats
  const s = String(x).trim();
  // yyyy-mm-dd
  if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(s)) return s;
  // dd/mm/yyyy or mm/dd/yyyy -> Date()
  const d = new Date(s);
  if(!isNaN(d)) return fmtDate(d);
  // 2025-09-01T..
  const d2 = new Date(Date.parse(s));
  if(!isNaN(d2)) return fmtDate(d2);
  return fmtDate(new Date());
}

// File System Access API
async function openFolderFSA(){
  if(!window.showDirectoryPicker){ toast('File System Access API not supported in this browser'); return; }
  try{
    const dir = await window.showDirectoryPicker();
    const files=[];
    for await (const [name, handle] of dir){
      if(handle.kind==='file' && name.toLowerCase().endsWith('.csv')){
        const file = await handle.getFile(); files.push(file);
      }
    }
    await handleFiles(files);
  }catch(e){ if(e?.name!=='AbortError') alert('Folder open failed: '+e.message); }
}

// ===== Exports =====
function exportTransactionsCSV(){
  const headers = ['id','date','description','payee','account','amount','categoryId'];
  const lines = [headers.join(',')].concat(state.transactions.map(t=> headers.map(h=> csvEscape(t[h])).join(',')));
  const blob = new Blob([lines.join('
')], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='transactions.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function csvEscape(v){
  const s = String(v??''); if(/[",
]/.test(s)) return '"'+ s.replace(/"/g,'""') +'"'; return s;
}

function exportCategoriesJSON(){
  const blob = new Blob([JSON.stringify(state.categories,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='categories.json'; a.click(); URL.revokeObjectURL(a.href);
}

function exportBackupJSON(){
  const backup = {
    version: APP_VERSION,
    exportedAt: new Date().toISOString(),
    transactions: state.transactions,
    categories: state.categories,
    rules: state.rules,
  };
  const blob = new Blob([JSON.stringify(backup,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='wsb-backup.json'; a.click(); URL.revokeObjectURL(a.href);
}

// ===== Charts (Canvas, no external deps) =====
let chartsRendered=false;
function renderCharts(force){
  if(chartsRendered && !force) return; chartsRendered=true;
  renderMonthlyChart();
  renderCategoryChart();
}

function renderMonthlyChart(){
  const canvas = $('#chart-monthly'); const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const monthly = {};
  for(const t of state.transactions){
    const m = (t.date||'').slice(0,7); if(!m) continue;
    monthly[m] = (monthly[m]||0) + Number(t.amount||0);
  }
  const labels = Object.keys(monthly).sort();
  const values = labels.map(l=> monthly[l]);
  drawBarChart(ctx, labels, values, {title:'Net by Month (CAD)', color:'#7c3aed'});
}

function renderCategoryChart(){
  const canvas = $('#chart-category'); const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const totals = new Map();
  for(const t of state.transactions){
    const cat = state.categories.find(c=>c.id===t.categoryId) || {name:'Uncategorized', color:'#6b7280'};
    const cur = totals.get(cat.name)||0; totals.set(cat.name, cur + (t.amount<0? -t.amount:0));
  }
  const entries = Array.from(totals.entries()).sort((a,b)=> b[1]-a[1]);
  const labels = entries.map(e=> e[0]);
  const values = entries.map(e=> e[1]);
  const colors = labels.map(n=> (state.categories.find(c=>c.name===n)||{}).color || '#6b7280');
  drawPieChart(ctx, labels, values, colors, {title:'Spending by Category'});
}

function drawBarChart(ctx, labels, values, opts={}){
  const W = ctx.canvas.width, H = ctx.canvas.height;
  const pad = 40; const titleH=24; const axisColor='#6b7280';
  // title
  ctx.fillStyle='#e6eefc'; ctx.font='16px Inter'; ctx.fillText(opts.title||'', pad, 20);
  const min = Math.min(0, ...values), max = Math.max(0, ...values);
  const plotH = H - pad - titleH; const plotW = W - pad*2;
  const yScale = v => {
    if(max===min) return H/2; return pad + plotH - ( (v-min)/(max-min) * plotH );
  };
  // axes
  ctx.strokeStyle=axisColor; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();
  const n = labels.length; const bw = Math.max(8, (plotW / Math.max(1,n)) * 0.6);
  const gap = (plotW - n*bw) / Math.max(1,n+1);
  ctx.fillStyle=opts.color||'#4f46e5';
  for(let i=0;i<n;i++){
    const x = pad + gap*(i+1) + bw*i;
    const y0 = yScale(0); const y = yScale(values[i]);
    const h = y0 - y; // could be negative
    ctx.fillRect(x, h>=0? y : y0, bw, Math.abs(h));
    // label
    ctx.fillStyle='#cbd5e1'; ctx.font='11px Inter';
    const lab = labels[i].slice(2); // show yy-mm
    ctx.fillText(lab, x, H-pad+12);
    ctx.fillStyle=opts.color||'#4f46e5';
  }
}

function drawPieChart(ctx, labels, values, colors, opts={}){
  const W = ctx.canvas.width, H = ctx.canvas.height; const cx=W/2, cy=H/2+10; const r=Math.min(W,H)/3;
  const sum = values.reduce((s,v)=>s+v,0)||1;
  let start= -Math.PI/2;
  for(let i=0;i<labels.length;i++){
    const val = values[i]; const ang = (val/sum)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle = colors[i]||'#4f46e5';
    ctx.arc(cx,cy,r,start,start+ang); ctx.closePath(); ctx.fill();
    start += ang;
  }
  // Legend
  const legendX = 10, legendY = 10;
  ctx.fillStyle='#e6eefc'; ctx.font='16px Inter'; ctx.fillText(opts.title||'', legendX, legendY);
  ctx.font='12px Inter';
  for(let i=0;i<labels.length;i++){
    ctx.fillStyle=colors[i]||'#4f46e5'; ctx.fillRect(legendX, legendY+12+ i*16, 10,10);
    ctx.fillStyle='#cbd5e1'; const pct = Math.round(values[i]/sum*100);
    ctx.fillText(`${labels[i]} â€” ${pct}%`, legendX+16, legendY+22 + i*16);
  }
}

// ===== Light Theme (optional) =====
document.body.classList.toggle('light', false);
// Basic toggle CSS variables by flipping class (CSS kept dark-first for brevity)

// ===== End =====

</script>
</body>
</html>
